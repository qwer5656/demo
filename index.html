<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://superal.github.io/canvas2image/canvas2image.js"></script>
</head>

<body>
    <div class="wrap" id="go">
        <div id="app"></div>
        <div class="container">
            <img class="imgfn" src="./img/動物角色_VR_企鵝.png" alt="">
            <img class="imgfn" src="./img/動物角色_VR_烏龜.png" alt="">
            <img class="imgfn" src="./img/動物角色_VR_鯨魚.png" alt="">
        </div>
        <div>
            <img id="opencam" class="imgbt" src="./img/1791174.png" alt="" onclick="test()">
            <img id="capture" class="imgbt" src="./img/capture.png" alt="" onclick="startcapture()" style="display:none">
        </div>
    </div>

    <div id="downloadwrap">
        <img id="downloadimg" class="imgbt" src="./img/downloading.png" onclick="download() " class="mid">
    </div>
    <div id="textfn">
    </div>


</body>
<style>
    .imgfn {

        width: 100px;
        height: 100px;
    }

    .imgbt {

        width: 80px;
        height: 80px;
    }

    .wrap {
        width: 100%;
        height: 100vh;
        display: flex;
        align-items: center;

        flex-direction: column;

    }

    .container {
        display: flex;
        justify-content: center;
    }

    video {
        display: none;
    }

    #app {
        height: 70vh;
        display: flex;
        align-items: flex-end;
    }

    #textfn {
        font-size: 7rem;
        top: 50%;
        position: fixed;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #060681;
    }

    #downloadimg {
        margin: 0 auto;
        display: none;
    }

    #save {
        height: 80vh !important;
    }
</style>
<script>

    let videos = null;
    function test() {

        if (videos == null) {


            const constraints = {
                audio: false,
                video: {
                    facingMode: "user"
                }
            };

            const getFrameFromVideo = (video, canvas) => {
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                ctx.translate(video.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, video.width, video.height);
                ctx.restore();
                requestAnimationFrame(() => getFrameFromVideo(video, canvas));
            };

            const getCameraStream = video => {
                navigator.mediaDevices
                    .getUserMedia(constraints)
                    .then(function success(stream) {
                        video.srcObject = stream;
                    });
            };

            const createVideo = (id, width, height) => {
                videos = document.createElement("video");
                videos.setAttribute("playsinline", "");
                videos.id = id;
                videos.width = 200;
                videos.height = 200;
                // video.autoplay = true;

                //  video.controls = true;
                return videos;
            };

            const createCanvas = (id, width, height) => {
                const canvas = document.createElement("canvas");
                canvas.id = id;
                canvas.width = width;
                canvas.height = height;
                return canvas;
            };

            const init = () => {
                const video = createVideo("vid", 200, 200);
                const canvas = createCanvas("canvas", 200, 200);
                const app = document.getElementById("app");
                getCameraStream(video);
                getFrameFromVideo(video, canvas);
                app.appendChild(video);
                app.appendChild(canvas);
                console.log("init ");
            };

            document.getElementById("app").onload = init();
        }
        videos.play();
        document.querySelector("#opencam").style.display = "none";
        document.querySelector("#capture").style.display = "block";
    }
    function startcapture() {
        document.querySelector("#capture").style.display = "none";
        let i = 3;

        let dp = function () {
            document.querySelector("#textfn").innerText = " " + i;
            setTimeout(function () {
                i -= 1;
                if (i != 0) {

                    dp();
                }
                else {
                    html2canvas(document.querySelector("#go")).then(canvas => {
                        canvas.id = "save";
                        document.querySelector("#downloadwrap").prepend(canvas);

                        document.querySelector("#downloadimg").style.display = "block";
                        console.log(canvas);
                    });
                    document.querySelector("#go").style.display = "none";
                    document.querySelector("#textfn").style.display = "none";


                }
            }, 1000);
        }
        dp();


    }

    function download() {
        let image = document.querySelector("#save");
        Canvas2Image.saveAsPNG(image);
    }
</script>

</html>